<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>2i2c Hub Configurator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Inter to echo 2i2c.org feel -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <!-- JSON5 for relaxed catalogs (comments, trailing commas) -->
  <script src="https://cdn.jsdelivr.net/npm/json5@2.2.3/dist/index.min.js" defer></script>
  <style>
    /* =========================
       2i2c-inspired Design Tokens
       ========================= */
    :root{
      --big-blue:#1D4EF5;   /* Primary */
      --pale-blue:#F2F5FC;  /* Light background */
      --midnight:#230344;   /* Deep contrast */
      --mauve:#B86BFC;      /* Accent gradient partner */
      --forest:#057761;     /* Success accent */
      --magenta:#C60A76;    /* Warn/error accent */

      /* Surfaces & text (light) */
      --bg:var(--pale-blue);
      --panel:#ffffff;
      --text:#0f1222;
      --muted:#5a627a;
      --line:#E3E7F2;
      --chip:#F7F9FF;

      /* Controls */
      --btn-bg:#ffffff;
      --btn-border:#D7DCF0;
      --btn-hover:#eef2ff;

      /* Shadows & radii */
      --radius-s:10px;
      --radius-m:14px;
      --shadow:0 6px 20px rgba(15,17,34,0.08);
      --focus:0 0 0 3px rgba(29,78,245,0.25);
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: radial-gradient(1200px 700px at 20% -20%, rgba(184,107,252,0.10), transparent 60%),
              radial-gradient(900px 600px at 120% 10%, rgba(29,78,245,0.12), transparent 50%),
              #0c0f1c;
        --panel:#121527;
        --text:#E9ECF8;
        --muted:#A5AEC8;
        --line:#232b43;
        --chip:#0F142A;
        --btn-bg:#141937;
        --btn-border:#25305a;
        --btn-hover:#18204b;
        --shadow:0 8px 26px rgba(0,0,0,0.35);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg);
      color:var(--text);
      font:16px/1.55 Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    a{color:var(--big-blue); text-decoration:none}
    a:hover{text-decoration:underline}

    .app{max-width:1100px;margin:32px auto;padding:0 16px 64px}

    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:22px;
      padding-bottom:10px; border-bottom:1px solid var(--line);
      background:
       linear-gradient(90deg, rgba(29,78,245,0.18), rgba(184,107,252,0.18)) bottom / 100% 2px no-repeat;
    }
    .title{font-size:clamp(22px,3.5vw,30px); font-weight:800; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px; max-width:60ch}

    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .tier-toggle{
      display:flex; background:var(--panel); border:1px solid var(--btn-border); border-radius:999px; padding:4px; box-shadow:var(--shadow);
    }
    .tier-btn{
      border:0; background:transparent; color:var(--muted); padding:8px 14px; border-radius:999px; cursor:pointer;
      font-weight:700; letter-spacing:.2px
    }
    .tier-btn.active{
      background:linear-gradient(180deg, #fff, #f6f8ff);
      color:#0b0f2a; border:1px solid var(--btn-border); box-shadow:inset 0 0 0 1px #eef1ff;
    }
    @media (prefers-color-scheme: dark){
      .tier-btn.active{
        background:linear-gradient(180deg, #1a1f45, #141a3a);
        color:var(--text); border:1px solid #2a3465; box-shadow:inset 0 0 0 1px #2a3465;
      }
    }

    .toolbar{display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap}
    .btn{
      background:var(--btn-bg); color:var(--text); border:1px solid var(--btn-border);
      border-radius:12px; padding:8px 12px; cursor:pointer; box-shadow:var(--shadow); font-weight:600;
    }
    .btn:hover{background:var(--btn-hover)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.ghost{background:transparent}

    .hint{font-size:12px; color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .grid{display:grid; grid-template-columns: 1.3fr 1fr; gap:10px; margin-top:16px}
    .group{grid-column:1/-1; margin-top:18px; display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:800; letter-spacing:.3px; text-transform:uppercase; font-size:12px}
    .group .line{height:1px; background:var(--line); flex:1}

    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius-m); padding:14px; display:flex; gap:10px; align-items:start; box-shadow:var(--shadow);
    }
    .label{font-weight:700}
    .help{color:var(--muted); font-size:13px; margin-top:6px}

    .right{display:flex; align-items:center; justify-content:flex-end}
    select{
      width:100%; background:linear-gradient(180deg,#fff,#f7f9ff); color:#0b0f2a; border:1px solid var(--btn-border); padding:10px 12px; border-radius:12px;
      outline:none; font-weight:600; box-shadow:var(--shadow);
    }
    select:focus{box-shadow:var(--focus)}
    @media (prefers-color-scheme: dark){
      select{background:linear-gradient(180deg,#121938,#0e1530); color:var(--text); border-color:#2a3465}
    }

    .static{
      background:var(--chip); border:1px solid var(--line); padding:8px 12px; border-radius:999px; display:inline-flex; align-items:center; gap:8px; box-shadow:var(--shadow)
    }
    .badge{display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:8px 12px; border:1px solid var(--line); box-shadow:var(--shadow)}
    .badge.ok{background:rgba(5,119,97,0.10); color:#064e3b; border-color:rgba(5,119,97,0.35)}
    .badge.no{background:rgba(198,10,118,0.10); color:#7b104b; border-color:rgba(198,10,118,0.35)}
    @media (prefers-color-scheme: dark){
      .badge.ok{background:rgba(12,239,174,0.12); color:#b6ffe7; border-color:rgba(12,239,174,0.35)}
      .badge.no{background:rgba(255,78,79,0.10); color:#ffd5da; border-color:rgba(255,78,79,0.35)}
    }

    .k{opacity:.8; font-size:12px; color:var(--muted)}
    .kv{font-weight:700}

    /* Inline, dynamic helper under controls */
    .opthelp{
      margin-top:8px;
      font-size:12px;
      line-height:1.4;
      color: var(--muted);
    }

    /* Dependency notes under controls */
    .depnote { margin-top:6px; font-size:12px; line-height:1.4; }
    .depnote.bad {
      color: var(--magenta);
      border-left: 3px solid var(--magenta);
      padding-left: 8px;
    }
    .depnote a { color: inherit; text-decoration: underline; }

    .footer{margin-top:24px; color:var(--muted); font-size:13px}
    .urlbox{
      margin-top:8px; display:flex; gap:8px; align-items:center; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:8px; box-shadow:var(--shadow)
    }
    .urlbox input{width:100%; background:transparent; border:0; color:var(--text); font:inherit; outline:none}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(180deg,#fff,#f7f9ff); color:var(--muted)}
    @media (prefers-color-scheme: dark){
      .pill{background:linear-gradient(180deg,#141a3a,#101633)}
    }

    .sep{height:1px;background:var(--line);margin:14px 0}

    .heroish{
      background:
        radial-gradient(800px 200px at 0% 0%, rgba(29,78,245,0.10), transparent 50%),
        radial-gradient(800px 200px at 100% 0%, rgba(184,107,252,0.10), transparent 50%);
      border-radius:20px; padding:12px;
    }

    @media (max-width:920px){
      .grid{grid-template-columns: 1fr}
      .right{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="heroish">
      <div>
        <div class="title">2i2c Hub Configurator</div>
        <div class="sub">
          Choose options for <span class="mono">Essential</span>, <span class="mono">Advanced</span>, and <span class="mono">Premier</span>.
          Switch tiers anytime—your picks stick per tier. Share or bookmark using the URL.
        </div>
      </div>
      <div class="row">
        <div class="tier-toggle" role="tablist" aria-label="Pick a tier">
          <button class="tier-btn" data-tier="Essential" role="tab" aria-selected="false">Essential</button>
          <button class="tier-btn" data-tier="Advanced" role="tab" aria-selected="false">Advanced</button>
          <button class="tier-btn" data-tier="Premier" role="tab" aria-selected="false">Premier</button>
        </div>
      </div>
    </header>

    <div class="toolbar">
      <button id="resetTier" class="btn" title="Reset current tier to catalog defaults">Reset tier to defaults</button>
      <button id="resetAll" class="btn ghost" title="Reset all tiers to defaults">Reset all</button>
      <span class="hint">Catalog: <span id="catalogName" class="mono">—</span> v<span id="catalogVersion">—</span></span>
      <span class="hint" style="margin-left:8px">Source: <span id="catalogUrl" class="mono"></span></span>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <div class="footer">
      <div><strong>Sharable link</strong> (auto-updates as you edit):</div>
      <div class="urlbox">
        <input id="shareUrl" type="text" readonly aria-label="Shareable URL" />
        <button id="copyUrl" class="btn" title="Copy URL to clipboard">Copy</button>
      </div>
      <div class="hint">Params: <span class="mono">?catalog=&lt;url&gt;</span> • <span class="mono">?json=true</span> for machine-readable output.</div>
      <div class="sep"></div>
      <div class="hint">Field legend: <span class="pill">single</span> fixed; <span class="pill">flag</span> included/excluded; <span class="pill">select</span> your choice.</div>
    </div>
  </div>

  <script>
  // -------- utilities: base64url + URL state --------
  const b64u = {
    enc: (str) => {
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    },
    dec: (b64u) => {
      const b64 = b64u.replace(/-/g,'+').replace(/_/g,'/') + '==='.slice((b64u.length+3)%4);
      return decodeURIComponent(escape(atob(b64)));
    }
  };

  function qs() { return new URLSearchParams(location.search); }
  function setShareUrl(urlStr){ const el = document.getElementById('shareUrl'); if(el) el.value = urlStr; history.replaceState(null,'', urlStr); }
  async function copyToClipboard(text){ try{ await navigator.clipboard.writeText(text); }catch(e){ /* ignore */ } }

  // -------- global app state --------
  const TIERS = ["Essential","Advanced","Premier"];
  const appState = {
    catalog: null,            // items[]
    catalogMeta: {name:"Unnamed Catalog", version:"0.0"},
    byGroup: new Map(),
    selections: {Essential:{}, Advanced:{}, Premier:{}},
    tier: "Essential"
  };

  // -------- catalog loading --------
  const DEFAULT_CATALOG = "catalogs/catalog.json";
  const catalogParam = qs().get('catalog');
  const catalogUrl = catalogParam ? decodeURIComponent(catalogParam) : DEFAULT_CATALOG;
  const jsonMode = (qs().get('json') === 'true');

  function setCatalogUiBits(){
    const nameEl = document.getElementById('catalogName');
    const verEl = document.getElementById('catalogVersion');
    const urlEl = document.getElementById('catalogUrl');
    if(nameEl) nameEl.textContent = appState.catalogMeta.name;
    if(verEl) verEl.textContent = appState.catalogMeta.version;
    if(urlEl) urlEl.textContent = catalogUrl;
  }

  async function loadCatalog(url){
    const res = await fetch(url, {cache:"no-store"});
    const txt = await res.text();
    const parsed = JSON5.parse(txt);

    // REQUIRED SHAPE: { name, version, items: [...] }
    if (!(parsed && typeof parsed === 'object' && Array.isArray(parsed.items))) {
      throw new Error("Invalid catalog: expected an object with shape { name, version, items: [...] }");
    }

    appState.catalogMeta = {
      name: String(parsed.name ?? "Unnamed Catalog"),
      version: String(parsed.version ?? "0.0")
    };
    appState.catalog = parsed.items;

    appState.byGroup = appState.catalog.reduce((m,it)=>{
      const g = it.group || "Other";
      if(!m.has(g)) m.set(g,[]);
      m.get(g).push(it);
      return m;
    }, new Map());
  }

  // -------- defaults from catalog --------
  function getDefaultValue(item, tier){
    const cfg = item?.perTier?.[tier];
    if(!cfg) return null;
    switch(cfg.kind){
      case "single": return cfg.text ?? null;
      case "flag"  : return !!cfg.available;
      case "select": {
        // options are objects {value,label?,help?,requires?}
        const opts = (cfg.options || []);
        const dv = cfg.default ?? (opts[0]?.value ?? null);
        return dv != null ? String(dv) : null;
      }
      default: return null;
    }
  }
  function ensureTierDefaults(tier){
    const dest = appState.selections[tier];
    appState.catalog.forEach(item=>{
      if(dest[item.id] === undefined){
        dest[item.id] = getDefaultValue(item, tier);
      }
    });
  }

  // -------- URL <-> state encoding --------
  function encodeStateToUrl(){
    const payload = {
      tier: appState.tier,
      selections: appState.selections,
      catalog: catalogParam ? catalogUrl : undefined // persist custom catalog only
    };
    const s = b64u.enc(JSON.stringify(payload));
    const url = new URL(location.href);
    url.searchParams.set('state', s);
    if(catalogParam){ url.searchParams.set('catalog', encodeURIComponent(catalogUrl)); }
    if(jsonMode){ url.searchParams.set('json','true'); }
    const clean = url.origin + url.pathname + '?' + url.searchParams.toString();
    setShareUrl(clean);
  }

  function tryRestoreFromUrl(){
    const s = qs().get('state');
    if(!s) return false;
    try{
      const obj = JSON.parse(b64u.dec(s));
      if(obj?.selections && obj?.tier){
        TIERS.forEach(t=>{ appState.selections[t] = obj.selections[t] || {}; });
        appState.tier = TIERS.includes(obj.tier) ? obj.tier : "Essential";
        return true;
      }
    }catch(e){ console.warn("Failed to parse state from URL", e); }
    return false;
  }

  // -------- helpers: options, labels, dependencies --------
  function normalizeOptions(opts){
    // Enforce object shape; tolerate string as convenience (maps to {value,label})
    return (opts || []).map(o => {
      if (typeof o === 'string') return { value: String(o), label: String(o), help: '' };
      return {
        value: String(o.value),
        label: String(o.label ?? o.value),
        help:  String(o.help ?? ''),
        requires: o.requires || null
      };
    });
  }

  function makeLabelIndex(catalog){
    const idx = {};
    catalog.forEach(it => { idx[it.id] = it.label || it.id; });
    return idx;
  }

  function makeOptionLabelGetter(catalog, tier){
    const map = {};
    catalog.forEach(it => {
      const cfg = it.perTier?.[tier];
      if(cfg?.kind === 'select'){
        normalizeOptions(cfg.options).forEach(o => {
          map[it.id] = map[it.id] || {};
          map[it.id][o.value] = o.label;
        });
      }
    });
    return (itemId, value) => map[itemId]?.[String(value)] || null;
  }

  function evalClause(cl, values){
    if(!cl || typeof cl !== 'object') return true;
    if(cl.allOf) return cl.allOf.every(c => evalClause(c, values));
    if(cl.anyOf) return cl.anyOf.some(c => evalClause(c, values));
    if(cl.not)   return !evalClause(cl.not, values);

    const left = values?.[cl.id];
    const op = cl.op || 'eq';
    const v  = cl.value;

    switch(op){
      case 'truthy': return !!left;
      case 'falsy':  return !left;
      case 'eq':     return String(left) === String(v);
      case 'neq':    return String(left) !== String(v);
      case 'in':     return Array.isArray(v) && v.map(String).includes(String(left));
      case 'nin':    return Array.isArray(v) && !v.map(String).includes(String(left));
      case 'gt':     return Number(left) >  Number(v);
      case 'gte':    return Number(left) >= Number(v);
      case 'lt':     return Number(left) <  Number(v);
      case 'lte':    return Number(left) <= Number(v);
      default:       return false;
    }
  }

  function describeClause(cl, labelById, optionLabelOf){
    if(!cl) return '';
    if(cl.allOf) return cl.allOf.map(c => describeClause(c, labelById, optionLabelOf)).join(' and ');
    if(cl.anyOf) return cl.anyOf.map(c => describeClause(c, labelById, optionLabelOf)).join(' or ');
    if(cl.not)   return 'not (' + describeClause(cl.not, labelById, optionLabelOf) + ')';

    const field = labelById[cl.id] || cl.id;
    const fmt = (val) => {
      if (Array.isArray(val)) return val.map(v => optionLabelOf(cl.id, v) || v).join(', ');
      return optionLabelOf(cl.id, val) || String(val);
    };
    const m = {eq:'=', neq:'≠', in:'∈', nin:'∉', gt:'>', gte:'≥', lt:'<', lte:'≤', truthy:'is set', falsy:'is not set'};
    if(cl.op === 'truthy' || cl.op === 'falsy') return `${field} ${m[cl.op]}`;
    return `${field} ${m[cl.op] || cl.op} ${fmt(cl.value)}`;
  }

  function collectReferencedIds(cl, acc=new Set()){
    if(!cl || typeof cl !== 'object') return acc;
    if(cl.allOf) cl.allOf.forEach(c => collectReferencedIds(c, acc));
    else if(cl.anyOf) cl.anyOf.forEach(c => collectReferencedIds(c, acc));
    else if(cl.not) collectReferencedIds(cl.not, acc);
    else if(cl.id) acc.add(cl.id);
    return acc;
  }

  // -------- rendering --------
  function h(tag, attrs={}, children=[]){
    const el = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs||{})){
      if(k==='class') el.className = v;
      else if(k==='html') el.innerHTML = v;
      else if(k.startsWith('on') && typeof v==='function') el.addEventListener(k.substring(2), v);
      else el.setAttribute(k, v);
    }
    (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
      if(typeof c === 'string') el.appendChild(document.createTextNode(c));
      else el.appendChild(c);
    });
    return el;
  }

  function renderTierTabs(){
    document.querySelectorAll('.tier-btn').forEach(btn=>{
      const t = btn.dataset.tier;
      const active = (t===appState.tier);
      btn.classList.toggle('active', active);
      btn.setAttribute('aria-selected', active ? 'true':'false');
    });
  }

  function renderGrid(){
    const grid = document.getElementById('grid');
    if(!grid) return;
    grid.innerHTML = '';

    const tier = appState.tier;
    ensureTierDefaults(tier);

    const labelById = makeLabelIndex(appState.catalog);
    const optionLabelOf = makeOptionLabelGetter(appState.catalog, tier);

    for(const [group, items] of appState.byGroup){
      grid.appendChild(h('div', {class:'group'}, [
        h('span', {}, group),
        h('div', {class:'line'})
      ]));

      items.forEach(item=>{
        const cfg = item.perTier?.[tier];
        if(!cfg){ return; }

        const left = h('div', {class:'card', id:`field-${item.id}`}, [
          h('div', {class:'label'}, item.label || item.id),
          item.help ? h('div', {class:'help'}, item.help) : null
        ]);

        let rightContent = null;

        if(cfg.kind === 'select'){
          const norm = normalizeOptions(cfg.options);
          const currentVal = String(appState.selections[tier][item.id] ?? cfg.default ?? (norm[0]?.value ?? ''));
          const selId = `${item.id}-select`;
          const helpId = `${item.id}-help`;

          const sel = h('select', { id: selId, 'aria-label': item.label || item.id, 'aria-describedby': helpId },
            norm.map(o => {
              let lab = o.label;
              if (o.requires) {
                const reqText = describeClause(o.requires, labelById, optionLabelOf);
                if (reqText) lab += ` (requires: ${reqText})`;
              }
              const opt = h('option', { value: o.value }, lab);
              if (o.value === currentVal) opt.selected = true;
              return opt;
            })
          );

          const helpTextFor = (val) => (norm.find(o => o.value === String(val))?.help || '').trim();
          const helpDiv = h('div', { class: 'opthelp', id: helpId, 'aria-live': 'polite' },
            helpTextFor(currentVal) || ' '
          );

          sel.addEventListener('change', e=>{
            appState.selections[tier][item.id] = e.target.value;
            helpDiv.textContent = helpTextFor(e.target.value) || ' ';
            encodeStateToUrl();
            renderGrid(); // refresh dependency notes
          });

          rightContent = h('div', {}, [sel, helpDiv]);

        } else if (cfg.kind === 'single'){
          const fixedVal = appState.selections[tier][item.id] ?? cfg.text ?? '';
          rightContent = h('div', {}, [
            h('div', {class:'static', title:'Fixed for this tier'}, [
              h('span', {class:'k'}, 'single'),
              h('span', {class:'kv'}, fixedVal)
            ]),
            cfg.help ? h('div', {class:'opthelp'}, cfg.help) : null
          ]);

        } else if (cfg.kind === 'flag'){
          const on = !!cfg.available;
          appState.selections[tier][item.id] = on; // reflect catalog
          rightContent = h('div', {}, [
            h('div', {class: 'badge ' + (on?'ok':'no'), title: on?'Included in this tier':'Not included in this tier'}, [
              h('span', {class:'k'}, 'flag'),
              h('span', {class:'kv'}, on ? 'Included' : 'Not included')
            ]),
            cfg.help ? h('div', {class:'opthelp'}, cfg.help) : null
          ]);

        } else {
          rightContent = h('div', {class:'static'}, 'Unsupported kind');
        }

        // ----- Dependency evaluation and note (keep control visible) -----
        let requirement = null;
        if (cfg.kind === 'select') {
          const opts = normalizeOptions(cfg.options);
          const current = appState.selections[tier][item.id];
          const currentOpt = opts.find(o => o.value === String(current));
          requirement = currentOpt?.requires || cfg.requires || null;
        } else {
          requirement = cfg.requires || null;
        }

        if (requirement) {
          const values = appState.selections[tier];
          const ok = evalClause(requirement, values);
          if (!ok) {
            const needs = describeClause(requirement, labelById, optionLabelOf);
            const ids = Array.from(collectReferencedIds(requirement));
            const links = ids.map(id => `<a href="#field-${id}">${labelById[id] || id}</a>`);
            const fixHint = links.length ? ` (jump to ${links.join(', ')})` : '';
            const depHtml = `Requires: ${needs}${fixHint}`;
            const note = h('div', {class:'depnote bad', role:'status', 'aria-live':'polite', html: depHtml});
            rightContent = h('div', {}, [ rightContent, note ]);
          }
        }

        // Append row
        grid.appendChild(left);
        grid.appendChild(h('div', {class:'right'}, rightContent));
      });
    }
  }

  // -------- actions --------
  function setTier(tier){
    if(!TIERS.includes(tier)) return;
    appState.tier = tier;
    renderTierTabs();
    renderGrid();
    encodeStateToUrl();
  }
  function resetTierToDefaults(){
    const tier = appState.tier;
    appState.selections[tier] = {};
    ensureTierDefaults(tier);
    renderGrid();
    encodeStateToUrl();
  }
  function resetAll(){
    appState.selections = {Essential:{}, Advanced:{}, Premier:{}};
    TIERS.forEach(ensureTierDefaults);
    renderGrid();
    encodeStateToUrl();
  }

  // -------- JSON mode output (application/json via Blob redirect) --------
  function emitJsonAndExit(){
    const selectedTier = appState.tier;
    const payload = {
      catalog: appState.catalogMeta,
      tier: selectedTier,
      selections: appState.selections[selectedTier]   // only the selected tier
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    // Navigate to a JSON blob so the browser sets Content-Type correctly.
    location.replace(url);
  }

  // -------- boot --------
  async function boot(){
    // Wire UI controls (harmless in json mode)
    document.querySelectorAll('.tier-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> setTier(btn.dataset.tier));
    });
    const resetTierBtn = document.getElementById('resetTier');
    const resetAllBtn  = document.getElementById('resetAll');
    const copyBtn      = document.getElementById('copyUrl');
    if(resetTierBtn) resetTierBtn.addEventListener('click', resetTierToDefaults);
    if(resetAllBtn)  resetAllBtn.addEventListener('click', resetAll);
    if(copyBtn)      copyBtn.addEventListener('click', ()=>copyToClipboard(document.getElementById('shareUrl').value));

    // Load catalog (needed for defaults even in json mode)
    try{
      await loadCatalog(catalogUrl);
    }catch(err){
      document.body.innerHTML = "<pre style='white-space:pre-wrap; padding:16px; font-family:monospace; color:#b91c1c; background:#fff5f5; border:1px solid #fecaca; border-radius:12px; max-width:960px; margin:24px auto;'>"
        + "Failed to load catalog.\n\n"
        + String(err.message || err)
        + "\n\nExpected shape:\n{\n  \"name\": \"...\",\n  \"version\": \"...\",\n  \"items\": [\n    {\n      \"id\": \"...\",\n      \"label\": \"...\",\n      \"help\": \"...\",\n      \"perTier\": {\n        \"Essential\": { \"kind\": \"select|flag|single\", ... },\n        \"Advanced\":  { ... },\n        \"Premier\":   { ... }\n      }\n    }\n  ]\n}\n</pre>";
      return;
    }
    setCatalogUiBits();

    // Restore state from URL if present; otherwise seed defaults
    const restored = tryRestoreFromUrl();
    if(!restored){ TIERS.forEach(ensureTierDefaults); }

    if(jsonMode){
      emitJsonAndExit();
      return;
    }

    // Normal UI render
    renderTierTabs();
    renderGrid();
    encodeStateToUrl();
  }

  if(document.readyState === 'loading'){ window.addEventListener('DOMContentLoaded', boot); }
  else { boot(); }
  </script>
</body>
</html>
