<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Catalog Builder â€” Outline + Inspector (Vanilla JS)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/json5@2.2.3/dist/index.min.js" defer></script>
<style>
  :root{
    --bg:#f6f8fc; --panel:#ffffff; --ink:#0f1326; --muted:#6b7390; --line:#e4e8f3;
    --brand:#445dff; --ok:#0e8c70; --err:#c7166f; --warn:#c88a00;
    --radius:12px; --focus:0 0 0 3px rgba(68,93,255,.25);
  }
  @media(prefers-color-scheme:dark){
    :root{ --bg:#0b0f1e; --panel:#101633; --ink:#e9ecf8; --muted:#a5aec8; --line:#28355c; }
  }
  *{box-sizing:border-box}
  html, body{height:auto; min-height:100%; margin:0; background:var(--bg); color:var(--ink);
             font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto; overflow-y:auto}
  a{color:var(--brand);text-decoration:none}
  a:hover{text-decoration:underline}
  input,select,textarea,button{font:inherit;color:inherit}

  .app{min-height:100vh; display:grid; grid-template-rows:auto 1fr}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;
         border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff,#f7f9ff)}
  .title{font-weight:800}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 10px;font-weight:700}
  .btn{background:#fff;border:1px solid var(--line);border-radius:10px;padding:7px 10px;cursor:pointer;font-weight:700}
  .btn:hover{background:#f4f7ff}
  .btn.icon{padding:5px 8px}
  .btn.danger{background:#fff1f6;border-color:#ffd4e6}
  .muted{color:var(--muted);font-size:12px}

  main{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius)}
  .sidebar{display:flex;flex-direction:column;min-width:0}
  .sideHead{padding:10px;border-bottom:1px solid var(--line);display:grid;grid-template-columns:1fr auto;gap:8px}
  .search{width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;padding:7px 9px;outline:none}
  .search:focus{box-shadow:var(--focus)}
  .outline{padding:6px 6px 12px 6px}
  .group{margin-top:8px}
  .groupHead{position:sticky;top:0;background:var(--panel);padding:6px 8px;font-size:12px;color:var(--muted);
             text-transform:uppercase;letter-spacing:.06em;border-bottom:1px dashed var(--line);z-index:2}
  .item{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:6px 8px;border:1px solid transparent;border-radius:10px;margin-top:6px}
  .item:hover{background:rgba(0,0,0,.03)}
  .item.active{border-color:var(--brand);box-shadow:var(--focus)}
  .id{font-size:12px;color:var(--muted)}
  .tags{display:flex;gap:4px;flex-wrap:wrap}
  .tag{border:1px solid var(--line);border-radius:999px;padding:1px 6px;font-size:11px;background:#fff;color:var(--muted)}
  .tag.err{color:var(--err);border-color:#ffd4e6;background:#fff5fa}
  .tag.warn{color:var(--warn);border-color:#ffe6b3;background:#fffaf0}

  .inspector{display:flex;flex-direction:column;min-width:0}
  .insHead{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line)}
  .insBody{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
  .fields{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .fields .full{grid-column:1/-1}
  label.k{font-size:12px;color:var(--muted)}
  input[type="text"], select, textarea{
    width:100%; background:#fff; border:1px solid var(--line); border-radius:10px; padding:7px 9px; outline:none; min-width:0;
  }
  textarea{min-height:72px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace}
  input:focus,select:focus,textarea:focus{box-shadow:var(--focus)}

  .tier{padding:10px;border:1px solid var(--line);border-radius:12px}
  .tier h3{margin:0 0 6px 0;font-size:13px}
  .tier .row{display:grid;grid-template-columns:140px 1fr;align-items:center;gap:8px;margin:6px 0}
  .mini{font-size:12px;color:var(--muted)}

  /* Select options table (no option-level requires or reordering; no default dropdown) */
  .table{border:1px solid var(--line);border-radius:10px;overflow:hidden;margin-top:6px}
  .thead, .trow{display:grid;grid-template-columns:140px 1fr 1fr 90px 80px;gap:6px;align-items:center;padding:6px;border-bottom:1px solid var(--line)}
  .thead{background:#f7f9ff;font-weight:700}
  .trow .btn{padding:5px 8px}

  .tray{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border-top:1px solid var(--line)}
  .errors{max-height:28vh;overflow:auto;display:flex;flex-direction:column;gap:6px;padding:8px}
  .errorRow{display:flex;gap:8px;border:1px dashed #f3a3c6;background:#fff5fa;padding:6px;border-radius:8px}
  .where{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <span class="title">Catalog Builder</span>
      <span class="pill">catalog.json</span>
      <span class="muted">Vanilla JS Â· Outline + Inspector</span>
    </div>
    <div class="bar">
      <button id="newBtn" class="btn">New</button>
      <button id="importUrlBtn" class="btn">Import URL</button>
      <label class="btn">Import File
        <input id="fileInput" type="file" accept=".json,.json5,application/json" style="display:none">
      </label>
      <button id="validateBtn" class="btn">Validate</button>
      <button id="downloadBtn" class="btn">Download JSON</button>
      <button id="copyBtn" class="btn">Copy JSON</button>
    </div>
  </header>

  <main>
    <!-- Sidebar: outline -->
    <section class="panel sidebar">
      <div class="sideHead">
        <input id="search" class="search" type="text" placeholder="Filter by id, label, group, helpâ€¦" />
        <button id="addItemBtn" class="btn">+ Item</button>
      </div>
      <div id="outline" class="outline" aria-live="polite"></div>
      <div class="tray">
        <div>
          <label class="k muted">Catalog name</label>
          <input id="catName" type="text" placeholder="e.g., Demo Catalog" style="width:180px">
        </div>
        <div>
          <label class="k muted">Version</label>
          <input id="catVersion" type="text" placeholder="e.g., 2025.08.23" style="width:120px">
        </div>
      </div>
    </section>

    <!-- Inspector -->
    <section class="panel inspector">
      <div class="insHead">
        <div class="bar">
          <strong id="insTitle">Select an item</strong>
          <span id="insId" class="muted"></span>
        </div>
        <div class="bar">
          <input id="publicUrl" class="search" type="text" placeholder="(optional) Public URL for this JSON" style="width:320px">
          <button id="openConfiguratorBtn" class="btn">Open in Configurator</button>
          <button id="dupItemBtn" class="btn">Duplicate</button>
          <button id="delItemBtn" class="btn danger">Delete</button>
        </div>
      </div>

      <div class="insBody" id="insBody">
        <!-- Left: general fields; Right: tiers -->
        <div class="fields">
          <div>
            <label class="k">ID (unique & stable)</label>
            <input id="itId" type="text" placeholder="group1:feature1">
          </div>
          <div>
            <label class="k">Group</label>
            <input id="itGroup" type="text" placeholder="Group 1">
          </div>
          <div class="full">
            <label class="k">Label (user-facing)</label>
            <input id="itLabel" type="text" placeholder="Feature 1">
          </div>
          <div class="full">
            <label class="k">Item help (short, markdown-safe)</label>
            <textarea id="itHelp" placeholder="Explain what this setting controls"></textarea>
          </div>
        </div>

        <div id="tiers">
          <!-- tier cards inserted here -->
        </div>

        <!-- Validation area (spans both columns) -->
        <div class="full" style="grid-column:1/-1">
          <div class="tray">
            <div><strong>Validation</strong> <span id="valSummary" class="muted"></span></div>
            <div class="bar">
              <button id="runValidation" class="btn">Run</button>
            </div>
          </div>
          <div id="errors" class="errors"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/* ===== Constants & tiny helpers ===== */
const TIERS = ["Essential","Advanced","Premier"];
const OPS = ['eq','neq','in','nin','gt','gte','lt','lte','truthy','falsy'];
const DEFAULT_CATALOG_URL = 'https://2i2c.org/hub-configurator/catalogs/catalog.json';

const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
function h(tag, attrs={}, children=[]){
  const el = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if(k==='class') el.className=v;
    else if(k==='html') el.innerHTML=v;
    else if(k.startsWith('on') && typeof v==='function') el.addEventListener(k.substring(2), v);
    else el.setAttribute(k, v);
  }
  (Array.isArray(children)?children:[children]).forEach(c=>{
    if(c==null) return;
    if(typeof c==='string') el.appendChild(document.createTextNode(c));
    else el.appendChild(c);
  });
  return el;
}
const deep = x => JSON.parse(JSON.stringify(x));
const nice = x => JSON.stringify(x, null, 2);
const copy = text => navigator.clipboard.writeText(text).catch(()=>{});

/* ===== State ===== */
const STORAGE_KEY='catalog-builder-outline-v1';
const state = { catalog: newCatalog(), selectedId: null, filter: '' };

function newCatalog(){ return { name:'New Catalog', version:new Date().toISOString().slice(0,10), items:[] }; }
function newItem(){
  return {
    id:'group1:feature1', group:'Group 1', label:'Feature 1', help:'',
    perTier:{
      Essential:{kind:'single', text:'fixed', help:''},
      Advanced:{kind:'flag', available:true, help:''},
      Premier:{kind:'select', options:[{value:'opt1', label:'Option 1', help:''}], default:'opt1', help:''}
    }
  };
}

/* ===== Persistence ===== */
function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.catalog)); }catch(e){} }
function load(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw){ state.catalog = JSON.parse(raw); return true; }
  }catch(e){}
  return false;
}

/* ===== Outline rendering ===== */
function groupOrder(){
  const seen = new Set(), order=[];
  (state.catalog.items||[]).forEach(it=>{ const g=it.group||'Other'; if(!seen.has(g)){ seen.add(g); order.push(g);} });
  return order;
}
function itemsByGroup(group){ return (state.catalog.items||[]).filter(it => (it.group||'Other')===group); }
function outlineMatches(it, q){
  if(!q) return true;
  q=q.toLowerCase();
  return (it.id||'').toLowerCase().includes(q) ||
         (it.group||'').toLowerCase().includes(q) ||
         (it.label||'').toLowerCase().includes(q) ||
         (it.help||'').toLowerCase().includes(q);
}
function renderOutline(){
  $('#catName').value = state.catalog.name || '';
  $('#catVersion').value = state.catalog.version || '';
  const box = $('#outline'); box.innerHTML='';

  const {errors,warnings} = validateCatalog(state.catalog);
  const errById=new Map(), warnById=new Map();
  errors.forEach(([where])=>{ const m=String(where).match(/items\[(\d+)\]/); if(m){ const it=state.catalog.items[+m[1]]; if(it) errById.set(it.id,true);} });
  warnings.forEach(([where])=>{ const m=String(where).match(/items\[(\d+)\]/); if(m){ const it=state.catalog.items[+m[1]]; if(it) warnById.set(it.id,true);} });

  const filter = state.filter.trim().toLowerCase();
  groupOrder().forEach(group=>{
    const list = itemsByGroup(group).filter(it=>outlineMatches(it,filter));
    if(!list.length && filter) return;
    const section = h('div',{class:'group'},[h('div',{class:'groupHead'},group)]);
    list.forEach(it=>{
      const active = (state.selectedId===it.id);
      const badges = h('div',{class:'tags'},[]);
      const hasSelect = TIERS.some(t=>it.perTier?.[t]?.kind==='select');
      const hasReq = TIERS.some(t => !!it.perTier?.[t]?.requires) ||
                     TIERS.some(t => (it.perTier?.[t]?.options||[]).some(o => !!o.requires));
      if(hasSelect) badges.appendChild(h('span',{class:'tag'},'select'));
      if(hasReq) badges.appendChild(h('span',{class:'tag'},'requires'));
      if(errById.has(it.id)) badges.appendChild(h('span',{class:'tag err'},'errors'));
      else if(warnById.has(it.id)) badges.appendChild(h('span',{class:'tag warn'},'warnings'));

      section.appendChild(
        h('div',{class:'item'+(active?' active':''), onclick:()=>selectItem(it.id)},[
          h('div',{},[
            h('div',{style:'font-weight:700'}, it.label || it.id),
            h('div',{class:'id'}, it.id)
          ]),
          badges
        ])
      );
    });
    box.appendChild(section);
  });
}

/* ===== Selection & Inspector ===== */
function selectItem(id){ state.selectedId=id; renderOutline(); renderInspector(); }
function bindText(input, obj, key){ input.value=obj[key]??''; input.oninput=()=>{ obj[key]=input.value; save(); renderOutline(); }; }

function renderInspector(){
  const it = state.catalog.items.find(i=>i.id===state.selectedId);
  $('#insTitle').textContent = it ? (it.label || 'â€”') : 'Select an item';
  $('#insId').textContent = it ? `(${it.id})` : '';

  const idField=$('#itId'), groupField=$('#itGroup'), labelField=$('#itLabel'), helpField=$('#itHelp');
  if(!it){
    [idField,groupField,labelField,helpField].forEach(el=>{el.value=''; el.disabled=true;});
    $('#tiers').innerHTML='';
    return;
  }
  [idField,groupField,labelField,helpField].forEach(el=>el.disabled=false);
  bindText(idField,it,'id'); bindText(groupField,it,'group'); bindText(labelField,it,'label');
  helpField.value=it.help||''; helpField.oninput=()=>{ it.help=helpField.value; save(); };

  const tiersBox=$('#tiers'); tiersBox.innerHTML='';
  TIERS.forEach(tier=>{
    const cfg = it.perTier[tier] || {kind:'single', text:''};
    it.perTier[tier]=cfg;

    const kindSel=h('select',{}); ['single','flag','select'].forEach(k=>kindSel.appendChild(h('option',{value:k},k)));
    kindSel.value=cfg.kind||'single';
    kindSel.onchange=e=>{ it.perTier[tier]=coerceKind(cfg,e.target.value); save(); renderInspector(); };

    const tierBox=h('div',{class:'tier'},[
      h('h3',{},tier),
      h('div',{class:'row'},[h('label',{class:'k'},'Kind'), kindSel]),
      (()=>{ const inp=h('input',{type:'text',placeholder:'Tier help (optional)'}); inp.value=cfg.help||''; inp.oninput=()=>{ cfg.help=inp.value; save(); }; return h('div',{class:'row'},[h('label',{class:'k'},'Tier help'), inp]); })(),
      buildKindFields(it,tier,cfg),
      buildRequiresEditor(cfg)
    ]);

    const status = defaultStatusForItem(it,tier);
    if(status) tierBox.appendChild(h('div',{class:'mini',style:'margin-top:6px;color:'+(status.type==='error'?'var(--err)':'var(--warn)')},status.text));
    tiersBox.appendChild(tierBox);
  });

  renderValidation();
}

function buildKindFields(item, tier, cfg){
  if(cfg.kind==='single'){
    const inp=h('input',{type:'text',placeholder:'Fixed text value'}); inp.value=cfg.text||'';
    inp.oninput=()=>{ cfg.text=inp.value; save(); };
    return h('div',{class:'row'},[h('label',{class:'k'},'Text'), inp]);
  }
  if(cfg.kind==='flag'){
    const sel=h('select',{}); [['true','Included'],['false','Not included']].forEach(([v,l])=>sel.appendChild(h('option',{value:v},l)));
    sel.value=String(!!cfg.available);
    sel.onchange=()=>{ cfg.available=(sel.value==='true'); save(); };
    return h('div',{class:'row'},[h('label',{class:'k'},'Availability'), sel]);
  }
  // select
  const table=h('div',{class:'table'},[
    h('div',{class:'thead'},[
      h('div',{},'Value'),
      h('div',{},'Label'),
      h('div',{},'Help'),
      h('div',{},'Default'),
      h('div',{},'Actions')
    ])
  ]);
  const body=h('div',{});
  (cfg.options||[]).forEach((opt,i)=>{
    const v=h('input',{type:'text'}); v.value=String(opt.value ?? ''); v.oninput=()=>{ opt.value=v.value; save(); };
    const l=h('input',{type:'text'}); l.value=String(opt.label ?? ''); l.oninput=()=>{ opt.label=l.value; save(); };
    const hp=h('input',{type:'text'}); hp.value=String(opt.help ?? ''); hp.oninput=()=>{ opt.help=hp.value; save(); };
    const def=h('input',{type:'radio', name:`def-${item.id}-${tier}`}); def.checked = String(cfg.default ?? '')===String(opt.value ?? '');
    def.onchange=()=>{ if(def.checked){ cfg.default=String(opt.value ?? ''); save(); } };
    const rm=h('button',{class:'btn danger icon', onclick:()=>{
      const removed = cfg.options.splice(i,1)[0];
      if(String(cfg.default)===String(removed?.value)){ cfg.default = cfg.options[0]?.value ?? ''; }
      save(); renderInspector();
    }},'ðŸ—‘');

    body.appendChild(h('div',{class:'trow'},[v,l,hp,def,rm]));
  });
  table.appendChild(body);

  const addRow = h('div',{class:'bar',style:'margin-top:6px'},[
    h('button',{class:'btn',onclick:()=>{
      cfg.options=cfg.options||[];
      let n=cfg.options.length+1; const used=new Set(cfg.options.map(o=>String(o.value)));
      while(used.has('option'+n)) n++;
      cfg.options.push({value:'option'+n, label:'Option '+n, help:''});
      if(!cfg.default) cfg.default = cfg.options[0]?.value ?? '';
      save(); renderInspector();
    }},'+ Add option'),
    h('span',{class:'mini'},'Set default via radio buttons above.')
  ]);

  return h('div',{},[
    table,
    addRow,
    h('div',{class:'mini',style:'margin-top:4px'},'Advanced: option-level dependencies are editable only in JSON.')
  ]);
}

function buildRequiresEditor(cfg){
  const wrap=h('div',{class:'row'},[
    h('label',{class:'k'},'Requires (item-level)'),
    (()=>{ const ta=h('textarea',{placeholder:'{ id:"group:feature", op:"eq", value:"opt2" }'}); ta.style.minHeight='72px';
           ta.value = cfg.requires ? JSON.stringify(cfg.requires, null, 2) : '';
           ta.onchange=()=>{
             const v=ta.value.trim();
             if(!v){ delete cfg.requires; save(); return; }
             try{
               const parsed=JSON5.parse(v);
               const errs=validateClause(parsed, new Set(state.catalog.items.map(i=>i.id)));
               if(errs.length) alert('Requires issue: '+errs.join('; '));
               else { cfg.requires=parsed; save(); }
             }catch(e){ alert('Parse error: '+(e.message||e)); }
           };
           return ta; })()
  ]);
  return wrap;
}

function coerceKind(cfg,k){
  if(k===cfg.kind) return cfg;
  if(k==='single') return {kind:'single', text:'', help:cfg.help||'', requires:cfg.requires||undefined};
  if(k==='flag')   return {kind:'flag', available:false, help:cfg.help||'', requires:cfg.requires||undefined};
  if(k==='select') return {kind:'select', options:[{value:'opt1', label:'Option 1', help:''}], default:'opt1', help:cfg.help||'', requires:cfg.requires||undefined};
  return cfg;
}

/* ===== Item actions (add/dup/del/reorder) ===== */
function addItem(){
  const it=newItem();
  const used=new Set(state.catalog.items.map(i=>i.id));
  let base='group1:feature', n=state.catalog.items.length+1;
  while(used.has(base+n)) n++;
  it.id=base+n; it.label='Feature '+n; it.group='Group '+Math.ceil(n/3);
  state.catalog.items.push(it);
  state.selectedId=it.id;
  save(); renderOutline(); renderInspector();
}
function deleteItem(){
  const i=state.catalog.items.findIndex(x=>x.id===state.selectedId);
  if(i<0) return;
  if(!confirm('Delete this item?')) return;
  state.catalog.items.splice(i,1);
  state.selectedId = state.catalog.items[i]?.id || state.catalog.items[i-1]?.id || null;
  save(); renderOutline(); renderInspector();
}
function duplicateItem(){
  const i=state.catalog.items.findIndex(x=>x.id===state.selectedId);
  if(i<0) return;
  const clone=deep(state.catalog.items[i]);
  let base=clone.id+'_copy', k=1;
  const used=new Set(state.catalog.items.map(x=>x.id));
  while(used.has(base+(k>1?k:''))) k++;
  clone.id=base+(k>1?k:'');
  state.catalog.items.splice(i+1,0,clone);
  state.selectedId=clone.id;
  save(); renderOutline(); renderInspector();
}
function moveSelected(delta){
  const i=state.catalog.items.findIndex(x=>x.id===state.selectedId);
  const j=i+delta;
  if(i<0 || j<0 || j>=state.catalog.items.length) return;
  const arr=state.catalog.items;
  [arr[i],arr[j]]=[arr[j],arr[i]];
  save(); renderOutline(); renderInspector();
}

/* ===== Import / Export ===== */
async function importFromUrl(){
  const u=prompt('Enter catalog URL (raw JSON/JSON5):'); if(!u) return;
  try{
    const res=await fetch(u,{cache:'no-store'});
    const text=await res.text();
    const parsed=JSON5.parse(text);
    state.catalog=coerceCatalog(parsed);
    state.selectedId=state.catalog.items[0]?.id || null;
    save(); renderOutline(); renderInspector(); renderValidation();
  }catch(e){ alert('Failed to fetch/parse: '+(e.message||e)); }
}
function importFromFile(file){
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const parsed=JSON5.parse(String(fr.result));
      state.catalog=coerceCatalog(parsed);
      state.selectedId=state.catalog.items[0]?.id || null;
      save(); renderOutline(); renderInspector(); renderValidation();
    }catch(e){ alert('Parse error: '+(e.message||e)); }
  };
  fr.readAsText(file);
}
function downloadJson(){
  const blob=new Blob([nice(state.catalog)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='catalog.json'; a.click();
  URL.revokeObjectURL(url);
}
function openInConfigurator(){
  const pub=$('#publicUrl').value.trim();
  if(!pub){ alert('Provide a public URL where this JSON will be hosted first.'); return; }
  const target=`https://2i2c.org/hub-configurator/?catalog=${encodeURIComponent(pub)}`;
  window.open(target,'_blank');
}

/* ===== Catalog coercion (strict v2; legacy unsupported) ===== */
function coerceCatalog(x){
  const cat={ name:String(x.name ?? 'Unnamed Catalog'), version:String(x.version ?? '0.0'), items:[] };
  if(Array.isArray(x.items)){
    x.items.forEach(raw=>{
      const it={
        id:String(raw.id ?? ''),
        group:String(raw.group ?? 'Other'),
        label:String(raw.label ?? raw.id ?? 'Item'),
        help:raw.help!=null ? String(raw.help) : '',
        perTier:{}
      };
      TIERS.forEach(t=>{
        const cfg=raw.perTier?.[t] || {kind:'single', text:''};
        if(cfg.kind==='single'){
          it.perTier[t]={kind:'single', text:String(cfg.text ?? ''), help:cfg.help!=null?String(cfg.help):'', requires:cfg.requires||undefined};
        }else if(cfg.kind==='flag'){
          it.perTier[t]={kind:'flag', available:!!cfg.available, help:cfg.help!=null?String(cfg.help):'', requires:cfg.requires||undefined};
        }else{
          const opts=(cfg.options||[]).map(o=> typeof o==='string'
            ? {value:String(o), label:String(o), help:''}
            : {value:String(o.value), label:String(o.label ?? o.value), help:String(o.help ?? ''), requires:o.requires||undefined});
          it.perTier[t]={kind:'select', options:opts, default: cfg.default!=null? String(cfg.default) : (opts[0]?.value ?? ''), help:cfg.help!=null?String(cfg.help):'', requires:cfg.requires||undefined};
        }
      });
      cat.items.push(it);
    });
  }
  return cat;
}

/* ===== Validation & dependency checks ===== */
function validateCatalog(cat){
  const errors=[]; const warn=[];
  if(!cat || typeof cat!=='object') errors.push(['$', 'Catalog must be an object']);
  if(typeof cat.name!=='string') errors.push(['name','name must be a string']);
  if(typeof cat.version!=='string') errors.push(['version','version must be a string']);
  if(!Array.isArray(cat.items)) errors.push(['items','items must be an array']);
  if(errors.length) return {errors,warnings:warn};

  const ids=new Set();
  (cat.items||[]).forEach((it,i)=>{
    if(typeof it.id!=='string' || !it.id.trim()) errors.push([`items[${i}].id`,'id must be a non-empty string']);
    if(ids.has(it.id)) errors.push([`items[${i}].id`,'duplicate id']);
    ids.add(it.id);

    if(typeof it.group!=='string') warn.push([`items[${i}].group`,'group should be a string']);
    if(typeof it.label!=='string') warn.push([`items[${i}].label`,'label should be a string']);
    if(it.help!=null && typeof it.help!=='string') warn.push([`items[${i}].help`,'help should be a string']);

    TIERS.forEach(t=>{
      const cfg=it.perTier?.[t];
      if(!cfg){ errors.push([`items[${i}].perTier.${t}`,'missing tier config']); return; }
      if(!['single','flag','select'].includes(cfg.kind)) errors.push([`items[${i}].perTier.${t}.kind`,'kind must be single|flag|select']);

      if(cfg.requires!=null){
        validateClause(cfg.requires, ids).forEach(msg=>errors.push([`items[${i}].perTier.${t}.requires`, msg]));
      }
      if(cfg.kind==='single'){
        if(typeof cfg.text!=='string') errors.push([`items[${i}].perTier.${t}.text`,'text must be string']);
        if(cfg.help!=null && typeof cfg.help!=='string') warn.push([`items[${i}].perTier.${t}.help`,'help should be string']);
      }else if(cfg.kind==='flag'){
        if(typeof cfg.available!=='boolean') errors.push([`items[${i}].perTier.${t}.available`,'available must be boolean']);
        if(cfg.help!=null && typeof cfg.help!=='string') warn.push([`items[${i}].perTier.${t}.help`,'help should be string']);
      }else if(cfg.kind==='select'){
        if(!Array.isArray(cfg.options) || !cfg.options.length) errors.push([`items[${i}].perTier.${t}.options`,'options must be a non-empty array']);
        else{
          const seen=new Set();
          cfg.options.forEach((o,j)=>{
            if(typeof o!=='object') errors.push([`items[${i}].perTier.${t}.options[${j}]`,'option must be object']);
            if(o.value==null) errors.push([`items[${i}].perTier.${t}.options[${j}].value`,'value is required']);
            const sval=String(o.value);
            if(seen.has(sval)) errors.push([`items[${i}].perTier.${t}.options[${j}].value`,'duplicate option value']);
            seen.add(sval);
            if(o.label!=null && typeof o.label!=='string') warn.push([`items[${i}].perTier.${t}.options[${j}].label`,'label should be string']);
            if(o.help!=null && typeof o.help!=='string') warn.push([`items[${i}].perTier.${t}.options[${j}].help`,'help should be string']);
            if(o.requires!=null){
              validateClause(o.requires, ids).forEach(msg=>errors.push([`items[${i}].perTier.${t}.options[${j}].requires`, msg]));
            }
          });
          if(cfg.default!=null){
            const ok = cfg.options.some(o=>String(o.value)===String(cfg.default));
            if(!ok) errors.push([`items[${i}].perTier.${t}.default`,'default must match an option value']);
          }else{
            warn.push([`items[${i}].perTier.${t}.default`,'default not set (UI uses first option)']);
          }
        }
        if(cfg.help!=null && typeof cfg.help!=='string') warn.push([`items[${i}].perTier.${t}.help`,'help should be string']);
      }
    });
  });

  defaultViability(cat).forEach(w=>warn.push(w));
  return {errors, warnings:warn};
}

function validateClause(cl, idSet){
  const errs=[];
  function rec(node, path){
    if(node==null || typeof node!=='object'){ errs.push(`${path}: must be object`); return; }
    if('allOf' in node){ if(!Array.isArray(node.allOf)||!node.allOf.length) errs.push(`${path}.allOf must be non-empty array`); else node.allOf.forEach((c,i)=>rec(c,`${path}.allOf[${i}]`)); return; }
    if('anyOf' in node){ if(!Array.isArray(node.anyOf)||!node.anyOf.length) errs.push(`${path}.anyOf must be non-empty array`); else node.anyOf.forEach((c,i)=>rec(c,`${path}.anyOf[${i}]`)); return; }
    if('not' in node){ rec(node.not, `${path}.not`); return; }
    if(typeof node.id!=='string' || !node.id) errs.push(`${path}.id missing or not string`);
    else if(idSet && !idSet.has(node.id)) errs.push(`${path}.id references unknown item "${node.id}"`);
    if(typeof node.op!=='string' || !OPS.includes(node.op)) errs.push(`${path}.op must be one of ${OPS.join(', ')}`);
    if(['truthy','falsy'].includes(node.op)){ if('value' in node) errs.push(`${path}.value must not be present for ${node.op}`); }
    else if(['in','nin'].includes(node.op)){ if(!Array.isArray(node.value)) errs.push(`${path}.value must be an array for ${node.op}`); }
    else { if(!('value' in node)) errs.push(`${path}.value required for ${node.op}`);
           if(['gt','gte','lt','lte'].includes(node.op)){ const n=Number(node.value); if(!Number.isFinite(n)) errs.push(`${path}.value should be numeric for ${node.op}`); } }
  }
  rec(cl,'$'); return errs;
}

function defaultViability(cat){
  const warns=[];
  TIERS.forEach(tier=>{
    const values={};
    cat.items.forEach(it=>{
      const cfg=it.perTier?.[tier]; if(!cfg) return;
      if(cfg.kind==='single') values[it.id]=cfg.text ?? null;
      if(cfg.kind==='flag') values[it.id]=!!cfg.available;
      if(cfg.kind==='select'){
        const dv = cfg.default!=null ? cfg.default : (cfg.options?.[0]?.value);
        values[it.id] = dv!=null ? String(dv) : null;
      }
    });
    cat.items.forEach(it=>{
      const cfg=it.perTier?.[tier]; if(!cfg) return;
      let req = cfg.requires || null;
      if(cfg.kind==='select'){
        const cur=values[it.id];
        const opt=(cfg.options||[]).find(o=>String(o.value)===String(cur));
        if(opt && opt.requires) req=opt.requires;
      }
      if(req && !evalClause(req, values)){
        warns.push([`defaults(${tier}).${it.id}`,'Default selection does not meet its requires']);
      }
    });
  });
  return warns;
}
function evalClause(cl, values){
  if(!cl || typeof cl!=='object') return true;
  if(cl.allOf) return cl.allOf.every(x=>evalClause(x,values));
  if(cl.anyOf) return cl.anyOf.some(x=>evalClause(x,values));
  if(cl.not) return !evalClause(cl.not,values);
  const left = values[cl.id];
  switch(cl.op){
    case 'truthy': return !!left;
    case 'falsy': return !left;
    case 'eq': return String(left)===String(cl.value);
    case 'neq': return String(left)!==String(cl.value);
    case 'in': return Array.isArray(cl.value) && cl.value.map(String).includes(String(left));
    case 'nin': return Array.isArray(cl.value) && !cl.value.map(String).includes(String(left));
    case 'gt': return Number(left) > Number(cl.value);
    case 'gte': return Number(left) >= Number(cl.value);
    case 'lt': return Number(left) < Number(cl.value);
    case 'lte': return Number(left) <= Number(cl.value);
    default: return true;
  }
}
function defaultStatusForItem(it,tier){
  const cfg=it.perTier?.[tier]; if(!cfg) return null;
  const values={};
  state.catalog.items.forEach(x=>{
    const c=x.perTier?.[tier];
    if(!c) return;
    if(c.kind==='single') values[x.id]=c.text ?? null;
    if(c.kind==='flag') values[x.id]=!!c.available;
    if(c.kind==='select'){
      const dv=c.default!=null?c.default:(c.options?.[0]?.value);
      values[x.id]=dv!=null?String(dv):null;
    }
  });
  let req=cfg.requires||null;
  if(cfg.kind==='select'){
    const cur=values[it.id];
    const opt=(cfg.options||[]).find(o=>String(o.value)===String(cur));
    if(opt && opt.requires) req=opt.requires;
  }
  if(req && !evalClause(req,values)) return {type:'error', text:'Default violates requires'};
  if(cfg.kind==='select'){
    const dead=(cfg.options||[]).filter(o=>o.requires && !evalClause(o.requires,values));
    if(dead.length) return {type:'warn', text:`${dead.length} option(s) currently unmet by defaults`};
  }
  return null;
}

function renderValidation(){
  const {errors,warnings}=validateCatalog(state.catalog);
  const box=$('#errors'); box.innerHTML='';
  const sum=$('#valSummary');
  if(!errors.length && !warnings.length){ sum.innerHTML='<span class="ok">No issues found</span>'; return; }
  sum.textContent=`${errors.length} error(s) â€¢ ${warnings.length} warning(s)`;
  [...errors,...warnings].forEach(([where,msg])=>{
    const row=h('div',{class:'errorRow'},[h('div',{class:'where'},where), h('div',{},msg)]);
    row.onclick=()=>{
      const m=String(where).match(/items\[(\d+)\]/);
      if(m){ const it=state.catalog.items[+m[1]]; if(it){ selectItem(it.id); } }
    };
    box.appendChild(row);
  });
}

/* ===== Boot ===== */
async function boot(){
  const hadLocal = load();
  if(!hadLocal){
    try{
      const res = await fetch(DEFAULT_CATALOG_URL, {cache:'no-store'});
      const txt = await res.text();
      state.catalog = coerceCatalog(JSON5.parse(txt));
      save();
    }catch(e){
      // if fetch fails, stick with blank newCatalog
      console.warn('Default catalog load failed:', e);
    }
  }
  renderOutline(); renderInspector(); renderValidation();

  // Sidebar
  $('#search').oninput=()=>{ state.filter=$('#search').value; renderOutline(); };
  $('#addItemBtn').onclick=addItem;

  // Header buttons
  $('#newBtn').onclick=()=>{ if(confirm('Start a new blank catalog?')){ state.catalog=newCatalog(); state.selectedId=null; save(); renderOutline(); renderInspector(); renderValidation(); } };
  $('#importUrlBtn').onclick=importFromUrl;
  $('#fileInput').onchange=(e)=>{ const f=e.target.files[0]; if(f) importFromFile(f); e.target.value=''; };
  $('#validateBtn').onclick=renderValidation;
  $('#downloadBtn').onclick=downloadJson;
  $('#copyBtn').onclick=()=>copy(nice(state.catalog));
  $('#openConfiguratorBtn').onclick=openInConfigurator;

  // Catalog identity
  $('#catName').oninput=()=>{ state.catalog.name=$('#catName').value; save(); };
  $('#catVersion').oninput=()=>{ state.catalog.version=$('#catVersion').value; save(); };

  // Inspector actions
  $('#delItemBtn').onclick=deleteItem;
  $('#dupItemBtn').onclick=duplicateItem;

  // Keyboard: ONLY Alt+ArrowUp / Alt+ArrowDown for item reordering
  window.addEventListener('keydown',(e)=>{
    if(e.altKey && e.key==='ArrowUp'){ e.preventDefault(); moveSelected(-1); }
    if(e.altKey && e.key==='ArrowDown'){ e.preventDefault(); moveSelected(1); }
  });
}
if(document.readyState==='loading') window.addEventListener('DOMContentLoaded', boot); else boot();
</script>
</body>
</html>
